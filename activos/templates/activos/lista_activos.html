{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Activos - SEMAT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static "activos/css/styless.css" %}">
    <style>
        /* Estilos adicionales para el modal */
        .modal-custom {
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content-custom {
            border-radius: 16px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .modal-header-custom {
            background: linear-gradient(135deg, #e63946, #d32f2f);
            color: white;
            border-bottom: none;
            padding: 1.5rem;
        }
        
        .warning-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .asset-code-modal {
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 10px;
            padding: 12px 20px;
            display: inline-block;
            margin: 15px 0;
            font-weight: 600;
            color: #4361ee;
            border-left: 4px solid #4361ee;
        }
        
        .btn-modal {
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-danger-modal {
            background: linear-gradient(135deg, #e63946, #d32f2f);
            color: white;
        }
        
        .btn-danger-modal:hover {
            background: linear-gradient(135deg, #d32f2f, #b71c1c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 57, 70, 0.3);
        }
        
        .btn-secondary-modal {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }
        
        .btn-secondary-modal:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
        }
        
        /* Estilo para el botón eliminar en la tabla */
        .btn-eliminar-modal {
            background-color: rgba(231, 57, 70, 0.1);
            color: #e63946;
            border: 1px solid rgba(231, 57, 70, 0.2);
        }
        
        .btn-eliminar-modal:hover {
            background-color: #e63946;
            color: white;
        }

        .btn-restaurar-modal {
            background-color: rgb(255, 255, 255);
            color: #17c711;
            border: 1px solid rgba(22, 177, 69, 0.2);
        }
        
        .btn-restaurar-modal:hover {
            background-color: #17c711;
            color: white;
        }
    </style>
   
</head>

<body>
    <div class="dashboard-container">

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section d-flex align-items-center">
                <img src="{% static 'activos/img/slider1.jpg' %}" alt="Logo" class="logo">
                <span class="brand-name">SEMAT</span>
            </div>

            <div class="nav-section">
                <div class="nav-title">Navegación</div>

                <a href="{% url 'dashboard' %}" class="nav-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>


                
            </div>

            <div class="nav-section">
                <div class="nav-title">Configuración</div>
                <a href="{% url 'logout' %}" class="nav-item">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Cerrar Sesión</span>
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">

            <div class="header">
                <h1 class="page-title">Lista de Activos</h1>

                <div class="user-menu">
                    <span>{{ request.user.username }}</span>
                    <div class="user-avatar">
                        {{ request.user.first_name|first|upper }}{{ request.user.last_name|first|upper }}
                    </div>
                </div>
            </div>

            

            <!-- Filters -->
            <div class="filters-container">
                <h5 class="filter-title">Filtros</h5>
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="depto" class="form-label">Departamento</label>
                        <select name="depto" id="depto" class="form-select">
                            <option value="">Todos los departamentos</option>
                            <option value="Administración y Finanzas" {% if departamento == "Administración y Finanzas" %}selected{% endif %}>Administración y Finanzas</option>
                            <option value="Fiscalización" {% if departamento == "Fiscalización" %}selected{% endif %}>Fiscalización</option>
                            <option value="Recaudación" {% if departamento == "Recaudación" %}selected{% endif %}>Recaudación</option>
                            <option value="Inmuebles Urbanos" {% if departamento == "Inmuebles Urbanos" %}selected{% endif %}>Inmuebles Urbanos</option>
                            <option value="Gerencia de Licores" {% if departamento == "Gerencia de Licores" %}selected{% endif %}>Gerencia de Licores</option>
                            <option value="Gerencia General" {% if departamento == "Gerencia General" %}selected{% endif %}>Gerencia General</option>
                            <option value="Jurídica" {% if departamento == "Jurídica" %}selected{% endif %}>Jurídica</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="estado" class="form-label">Estado</label>
                        <select name="estado" id="estado" class="form-select">
                            <option value="">Todos los estados</option>
                            <option value="operativo" {% if estado == "operativo" %}selected{% endif %}>Operativos</option>
                            <option value="dañado" {% if estado == "dañado" %}selected{% endif %}>Dañados</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-funnel"></i> Filtrar
                        </button>
                        <a href="{% url 'lista_activos' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>

            <!-- TABLE -->
            <div class="table-container">

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="table-title">
                        {% if estado == "dañado" %}
                            Activos Dañados
                        {% elif estado == "operativo" %}
                            Activos Operativos
                        {% else %}
                            Todos los Activos
                        {% endif %}
                    </h3>
                    
                </div>

                {% if activos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Codigo</th>
                                <th>Serial</th>
                                <th>Descripción</th>
                                <th>Departamento</th>
                                <th>Estado</th>
                                <th>Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activo in activos %}
                            <tr>
                                <td><strong>{{ activo.codigo|default:activo.id }}</strong></td>
                                <td><strong>{{ activo.serial|default:activo.id }}</strong></td>
                                <td><strong>{{ activo.descripcion }}</strong></td>
                                <td><strong>{{ activo.departamento }}</strong></td>
                                <td>
                                    {% if activo.condicion == "dañado" %}
                                        <span class="status-badge status-warning">Dañado</span>
                                    {% else %}
                                        <span class="status-badge status-success">Operativo</span>
                                    {% endif %}
                                </td>
                                <td>
                                 <div class="btn-group">
                                 {% if activo.condicion != "dañado" %}
                             <a href="{% url 'editar_activo' activo.id %}" class="btn btn-outline-primary btn-action">
                                 <i class="bi bi-pencil"></i> Editar
                             </a>

                              <button type="button" class="btn btn-eliminar-modal btn-action" 
                                     data-bs-toggle="modal" 
                                     data-bs-target="#deleteModal"
                                      data-activo-id="{{ activo.id }}"
                                      data-activo-serial="{{ activo.serial|default:activo.id }}"
                                       data-activo-nombre="{{ activo.nombre }}">
                                 <i class="bi bi-trash"></i> Eliminar
                              </button>
                              <a href="{% url 'transferir_activo' activo.id %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-exchange-alt"></i> Transferir
    </a>

                               {% else %}
                                <button type="button" class="btn btn-restaurar-modal btn-action" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#restaurarModal"
                                        data-activo-id="{{ activo.id }}"
                                        data-activo-serial="{{ activo.serial|default:activo.id }}"
                                        data-activo-codigo="{{ activo.codigo }}">
                                    <i class="bi bi-arrow-clockwise"></i> Restaurar
                                </button>
                                {% endif %}
                             </div>
                            </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No se encontraron activos</h4>
                    <p class="text-muted">
                        {% if departamento or estado %}
                            No hay activos que coincidan con los filtros aplicados.
                        {% else %}
                            No hay activos registrados en el sistema.
                        {% endif %}
                    </p>
                    <a href="{% url 'lista_activos' %}" class="btn btn-primary mt-3">
                        <i class="bi bi-arrow-clockwise"></i> Ver todos los activos
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

<!-- Modal de Restauración -->
<div class="modal fade" id="restaurarModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Restaurar Activo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de restaurar el activo <strong id="activoCodigoDisplay"></strong> (Serial: <span id="activoSerialDisplay"></span>)?</p>
                <p class="text-muted">El activo cambiará de estado "Dañado" a "Operativo".</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formRestaurarActivo" method="POST" action="{% url 'restaurar_activo' 0 %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success">Confirmar Restauración</button>
                </form>
            </div>
        </div>
    </div>
</div>

    <!-- Modal de Confirmación de Eliminación -->
    <div class="modal fade modal-custom" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-content-custom">
                <div class="modal-header modal-header-custom text-center">
                    <div class="w-100">
                        <i class="bi bi-exclamation-triangle-fill warning-icon"></i>
                        <h5 class="modal-title fw-bold" id="deleteModalLabel">Confirmar Eliminación</h5>
                    </div>
                </div>
                <div class="modal-body p-4 p-md-5 text-center">
                    <p class="mb-4 fs-5 text-muted">
                        ¿Estás seguro que deseas eliminar el siguiente activo del sistema?
                    </p>
                    
                    <div class="asset-code-modal mb-4" id="assetCodeDisplay">
                        <!-- Código del activo se insertará aquí -->
                    </div>
                    
                    <div class="alert alert-warning border-0 rounded-3 mb-4" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Esta acción no se puede deshacer. 
                    </div>
                    
                    <form method="POST" action="{% url 'eliminar_activo' 0 %}" id="deleteForm">
                        {% csrf_token %}
                        <input type="hidden" id="activoIdInput" name="activo_id">
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <button type="button" class="btn btn-secondary-modal btn-modal" data-bs-dismiss="modal">
                                <i class="bi bi-arrow-left me-2"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-danger-modal btn-modal">
                                <i class="bi bi-trash me-2"></i> Confirmar Eliminación
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configurar el modal para mostrar la información del activo correcto
        document.addEventListener('DOMContentLoaded', function() {
            const deleteModal = document.getElementById('deleteModal');
            const deleteForm = document.getElementById('deleteForm');
            
            deleteModal.addEventListener('show.bs.modal', function(event) {
                // Botón que activó el modal
                const button = event.relatedTarget;
                
                // Extraer información de los atributos data-*
                const activoId = button.getAttribute('data-activo-id');
                const activoSerial = button.getAttribute('data-activo-serial');
                const activoNombre = button.getAttribute('data-activo-nombre');
                
                // Actualizar el contenido del modal
                const assetCodeDisplay = document.getElementById('assetCodeDisplay');
                assetCodeDisplay.innerHTML = `<i class="bi bi-upc-scan me-2"></i> ${activoSerial} - ${activoNombre}`;
                
                // Actualizar el campo oculto del formulario
                document.getElementById('activoIdInput').value = activoId;
                
                // Actualizar la acción del formulario con la URL correcta
                const actionUrl = "{% url 'eliminar_activo' 0 %}".replace('/0/', `/${activoId}/`);
                deleteForm.action = actionUrl;
            });
        });
    </script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener referencia al modal
    const restaurarModal = document.getElementById('restaurarModal');
    
    // Evento que se dispara cuando el modal se va a mostrar
    restaurarModal.addEventListener('show.bs.modal', function(event) {
        // El botón que disparó el modal
        const button = event.relatedTarget;
        
        // Extraer datos del botón
        const activoId = button.getAttribute('data-activo-id');
        const activoSerial = button.getAttribute('data-activo-serial');
        const activoCodigo = button.getAttribute('data-activo-codigo');
        
        console.log('Datos del activo:', {
            id: activoId,
            serial: activoSerial,
            codigo: activoCodigo
        });
        
        // Actualizar el contenido del modal
        const modalCodigo = document.getElementById('activoCodigoDisplay');
        const modalSerial = document.getElementById('activoSerialDisplay');
        
        if (modalCodigo) modalCodigo.textContent = activoCodigo || 'N/A';
        if (modalSerial) modalSerial.textContent = activoSerial || 'N/A';
        
        // Actualizar la URL del formulario
        const form = document.getElementById('formRestaurarActivo');
        if (form) {
            // Reemplazar el 0 en la URL por el ID real
            const currentAction = form.getAttribute('action');
            const newAction = currentAction.replace('/0/', `/${activoId}/`);
            form.setAttribute('action', newAction);
            
            console.log('URL del formulario actualizada:', newAction);
        }
    });
    
    // Opcional: Resetear la URL cuando se cierra el modal
    restaurarModal.addEventListener('hidden.bs.modal', function() {
        const form = document.getElementById('formRestaurarActivo');
        if (form) {
            // Resetear a la URL original con 0
            const originalAction = "{% url 'restaurar_activo' 0 %}";
            form.setAttribute('action', originalAction);
        }
    });
});
</script>
</body>
</html>
